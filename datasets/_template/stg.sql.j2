-- =============================================================================
-- dbt/models/staging/stg_{{ name }}.sql
-- Generated by: make scaffold DATASET={{ name }}
-- =============================================================================
-- Passthrough staging model: reads from Silver Iceberg via iceberg_scan(),
-- applies minimal column aliases, and filters nulls on the event timestamp.
--
-- Update dbt/models/sources/sources.yml to point at your Silver path.
-- =============================================================================

with source as (
    select * from {{ '{{' }} source('raw_{{ name }}', 'cleaned_{{ name }}') {{ '}}' }}
),

renamed as (
    select
        -- Surrogate key
        {{ name }}_id,

        -- Timestamps and partition
{% for col in columns %}
{% set sname = col.silver_name if col.silver_name is defined else col.name %}
{% if col.bronze_type == 'TIMESTAMP(3)' or col.silver_type == 'TIMESTAMP(3)' %}
        {{ sname }},
{% endif %}
{% endfor %}
        {{ partition_date_col }},

        -- Measures and dimensions
{% for col in columns %}
{% set sname = col.silver_name if col.silver_name is defined else col.name %}
{% if col.bronze_type != 'TIMESTAMP(3)' and col.silver_type != 'TIMESTAMP(3)' %}
        {{ sname }},
{% endif %}
{% endfor %}

        -- Metadata
        ingestion_ts

    from source
    where {{ (columns | selectattr('is_event_ts', 'defined') | map(attribute='silver_name') | list | first) }} is not null
)

select * from renamed
