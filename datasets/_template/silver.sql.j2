-- =============================================================================
-- 06_silver.sql.tmpl — Silver Layer: Bronze → Cleaned, Deduplicated, Partitioned
-- Generated by: make scaffold DATASET={{ name }}
-- =============================================================================
-- Silver = clean, typed, deduplicated, partitioned analytical table.
-- Reads from iceberg_catalog.{{ bronze_table }}; writes to iceberg_catalog.{{ silver_table }}.
--
-- Column naming: all snake_case renaming from original Parquet names happens HERE.
-- dbt staging expects these exact silver column names.
-- =============================================================================

SET 'execution.runtime-mode' = 'batch';
SET 'table.dml-sync' = 'true';

-- Silver table DDL
-- Pattern: surrogate key (trip_id) first, partition DATE column last
CREATE TABLE IF NOT EXISTS iceberg_catalog.{{ silver_table }} (
    {{ name }}_id                   STRING,          -- MD5 surrogate key
{% for col in columns %}
{% if col.is_event_ts is not defined or not col.is_event_ts %}
    {{ (col.silver_name if col.silver_name is defined else col.name) | ljust(32) }}{{ col.silver_type }},
{% else %}
    {{ (col.silver_name if col.silver_name is defined else col.name) | ljust(32) }}{{ col.silver_type }},
{% endif %}
{% endfor %}
    ingestion_ts                    TIMESTAMP(3),
    {{ partition_date_col | ljust(32) }}DATE             -- partition column (always last)
) PARTITIONED BY ({{ partition_date_col }})
WITH (
    'format-version'                    = '2',
    'write.format.default'              = 'parquet',
    'write.parquet.compression-codec'   = 'snappy'
);

-- Deduplicate and clean bronze data
INSERT INTO iceberg_catalog.{{ silver_table }}
SELECT
    -- MD5 surrogate key — same fields as dedup_key for replay stability
    MD5(CONCAT_WS('|',
{% for field in surrogate_key_fields %}
        COALESCE(CAST({{ field }} AS STRING), ''){% if not loop.last %},{% endif %}

{% endfor %}
    )) AS {{ name }}_id,
    -- Column casts from bronze → silver
{% for col in columns %}
{% set sname = col.silver_name if col.silver_name is defined else col.name %}
{% if col.is_event_ts is defined and col.is_event_ts %}
    {{ col.name | ljust(40) }}AS {{ sname }},
{% elif col.bronze_type == 'TIMESTAMP(3)' and col.silver_type == 'TIMESTAMP(3)' %}
    {{ col.name | ljust(40) }}AS {{ sname }},
{% elif col.silver_type == col.bronze_type %}
    {{ col.name | ljust(40) }}AS {{ sname }},
{% else %}
    CAST({{ col.name }} AS {{ col.silver_type }}){{ '' | ljust(max(0, 36 - col.name|length)) }} AS {{ sname }},
{% endif %}
{% endfor %}
    ingestion_ts,
    {{ partition_date_expr }}            AS {{ partition_date_col }}
FROM (
    SELECT
        *,
        -- Deduplication: keep latest ingestion per natural key
        ROW_NUMBER() OVER (
            PARTITION BY {{ dedup_key | join(', ') }}
            ORDER BY ingestion_ts DESC
        ) AS rn
    FROM iceberg_catalog.{{ bronze_table }}
    WHERE
{% for f in quality_filters %}
        {{ f }}{% if not loop.last %} AND{% endif %}

{% endfor %}
) t
WHERE rn = 1;
