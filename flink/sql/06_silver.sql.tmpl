-- =============================================================================
-- 06_silver.sql.tmpl — Silver Layer: Bronze → Cleaned, Deduplicated, Partitioned
-- Generated by: make scaffold DATASET=taxi
-- =============================================================================
-- Silver = clean, typed, deduplicated, partitioned analytical table.
-- Reads from iceberg_catalog.bronze.raw_trips; writes to iceberg_catalog.silver.cleaned_trips.
--
-- Column naming: all snake_case renaming from original Parquet names happens HERE.
-- dbt staging expects these exact silver column names.
-- =============================================================================

SET 'execution.runtime-mode' = 'batch';
SET 'table.dml-sync' = 'true';

-- Silver table DDL
-- Pattern: surrogate key (trip_id) first, partition DATE column last
CREATE TABLE IF NOT EXISTS iceberg_catalog.silver.cleaned_trips (
    trip_id                   STRING,          -- MD5 surrogate key
    vendor_id                       INT,
    pickup_datetime                 TIMESTAMP(3),
    dropoff_datetime                TIMESTAMP(3),
    passenger_count                 INT,
    trip_distance_miles             DOUBLE,
    rate_code_id                    INT,
    store_and_fwd_flag              STRING,
    pickup_location_id              INT,
    dropoff_location_id             INT,
    payment_type_id                 INT,
    fare_amount                     DECIMAL(10, 2),
    extra_amount                    DECIMAL(10, 2),
    mta_tax                         DECIMAL(10, 2),
    tip_amount                      DECIMAL(10, 2),
    tolls_amount                    DECIMAL(10, 2),
    improvement_surcharge           DECIMAL(10, 2),
    total_amount                    DECIMAL(10, 2),
    congestion_surcharge            DECIMAL(10, 2),
    airport_fee                     DECIMAL(10, 2),
    ingestion_ts                    TIMESTAMP(3),
    pickup_date                     DATE             -- partition column (always last)
) PARTITIONED BY (pickup_date)
WITH (
    'format-version'                    = '2',
    'write.format.default'              = 'parquet',
    'write.parquet.compression-codec'   = 'snappy'
);

-- Deduplicate and clean bronze data
INSERT INTO iceberg_catalog.silver.cleaned_trips
SELECT
    -- MD5 surrogate key — same fields as dedup_key for replay stability
    MD5(CONCAT_WS('|',
        COALESCE(CAST(VendorID AS STRING), ''),
        COALESCE(CAST(tpep_pickup_datetime AS STRING), ''),
        COALESCE(CAST(tpep_dropoff_datetime AS STRING), ''),
        COALESCE(CAST(PULocationID AS STRING), ''),
        COALESCE(CAST(DOLocationID AS STRING), ''),
        COALESCE(CAST(fare_amount AS STRING), ''),
        COALESCE(CAST(total_amount AS STRING), '')
    )) AS trip_id,
    -- Column casts from bronze → silver
    CAST(VendorID AS INT)                             AS vendor_id,
    tpep_pickup_datetime                    AS pickup_datetime,
    tpep_dropoff_datetime                   AS dropoff_datetime,
    CAST(passenger_count AS INT)                      AS passenger_count,
    trip_distance                           AS trip_distance_miles,
    CAST(RatecodeID AS INT)                           AS rate_code_id,
    store_and_fwd_flag                      AS store_and_fwd_flag,
    CAST(PULocationID AS INT)                         AS pickup_location_id,
    CAST(DOLocationID AS INT)                         AS dropoff_location_id,
    CAST(payment_type AS INT)                         AS payment_type_id,
    CAST(fare_amount AS DECIMAL(10, 2))                          AS fare_amount,
    CAST(extra AS DECIMAL(10, 2))                                AS extra_amount,
    CAST(mta_tax AS DECIMAL(10, 2))                              AS mta_tax,
    CAST(tip_amount AS DECIMAL(10, 2))                           AS tip_amount,
    CAST(tolls_amount AS DECIMAL(10, 2))                         AS tolls_amount,
    CAST(improvement_surcharge AS DECIMAL(10, 2))                AS improvement_surcharge,
    CAST(total_amount AS DECIMAL(10, 2))                         AS total_amount,
    CAST(congestion_surcharge AS DECIMAL(10, 2))                 AS congestion_surcharge,
    CAST(Airport_fee AS DECIMAL(10, 2))                          AS airport_fee,
    ingestion_ts,
    CAST(tpep_pickup_datetime AS DATE)            AS pickup_date
FROM (
    SELECT
        *,
        -- Deduplication: keep latest ingestion per natural key
        ROW_NUMBER() OVER (
            PARTITION BY VendorID, tpep_pickup_datetime, tpep_dropoff_datetime, PULocationID, DOLocationID, fare_amount, total_amount
            ORDER BY ingestion_ts DESC
        ) AS rn
    FROM iceberg_catalog.bronze.raw_trips
    WHERE
        tpep_pickup_datetime IS NOT NULL AND
        tpep_dropoff_datetime IS NOT NULL AND
        total_amount > 0 AND
        trip_distance >= 0 AND
        passenger_count >= 0 AND
        CAST(tpep_pickup_datetime AS DATE) >= DATE '2024-01-01' AND
        CAST(tpep_pickup_datetime AS DATE) <  DATE '2024-02-01'
) t
WHERE rn = 1;
