-- =============================================================================
-- 06_silver.sql.tmpl — Silver Layer: Bronze → Cleaned, Deduplicated, Partitioned
-- =============================================================================
-- Silver = clean, typed, deduplicated, partitioned analytical table.
-- Reads from bronze.raw_trips (Iceberg); writes to silver.cleaned_trips.
-- Runs in batch mode using the iceberg catalog (session set in 00_catalog.sql).
--
-- CUSTOMIZE THIS FILE for a new dataset:
--   1. TODO (1/5): Silver table column list (snake_case, correct types)
--   2. TODO (2/5): Natural key for ROW_NUMBER() deduplication
--   3. TODO (3/5): Data quality filters (nulls, ranges, date bounds)
--   4. TODO (4/5): MD5 surrogate key fields (same as PARTITION BY above)
--   5. TODO (5/5): Column mapping and type casts from bronze → silver
-- =============================================================================

SET 'execution.runtime-mode' = 'batch';
SET 'table.dml-sync' = 'true';

-- TODO (1/5): Silver table column list
-- Pattern: event_id (MD5 surrogate) first, partition col (DATE) last
CREATE TABLE IF NOT EXISTS iceberg_catalog.silver.cleaned_trips (
    trip_id                 STRING,          -- MD5 surrogate key
    vendor_id               INT,
    tpep_pickup_datetime    TIMESTAMP(3),
    tpep_dropoff_datetime   TIMESTAMP(3),
    passenger_count         INT,
    trip_distance           DECIMAL(10, 2),
    rate_code_id            INT,
    store_and_fwd_flag      STRING,
    pickup_location_id      INT,
    dropoff_location_id     INT,
    payment_type            INT,
    fare_amount             DECIMAL(10, 2),
    extra                   DECIMAL(10, 2),
    mta_tax                 DECIMAL(10, 2),
    tip_amount              DECIMAL(10, 2),
    tolls_amount            DECIMAL(10, 2),
    improvement_surcharge   DECIMAL(10, 2),
    total_amount            DECIMAL(10, 2),
    congestion_surcharge    DECIMAL(10, 2),
    airport_fee             DECIMAL(10, 2),
    ingestion_ts            TIMESTAMP(3),
    pickup_date             DATE             -- partition column (always last)
) PARTITIONED BY (pickup_date)
WITH (
    'format-version'                    = '2',
    'write.format.default'              = 'parquet',
    'write.parquet.compression-codec'   = 'snappy'
);

-- Deduplicate and clean bronze data
INSERT INTO iceberg_catalog.silver.cleaned_trips
SELECT
    -- TODO (4/5): MD5 surrogate key — use fields that uniquely identify a record
    MD5(CONCAT_WS('|',
        COALESCE(vendor_id, ''),
        COALESCE(CAST(tpep_pickup_datetime AS STRING), ''),
        COALESCE(CAST(tpep_dropoff_datetime AS STRING), ''),
        COALESCE(CAST(pu_location_id AS STRING), '')
    )) AS trip_id,
    -- TODO (5/5): Column mapping and type casts
    CAST(vendor_id AS INT)                          AS vendor_id,
    tpep_pickup_datetime,
    tpep_dropoff_datetime,
    CAST(passenger_count AS INT)                    AS passenger_count,
    CAST(trip_distance AS DECIMAL(10, 2))           AS trip_distance,
    CAST(rate_code_id AS INT)                       AS rate_code_id,
    store_and_fwd_flag,
    CAST(pu_location_id AS INT)                     AS pickup_location_id,
    CAST(do_location_id AS INT)                     AS dropoff_location_id,
    CAST(payment_type AS INT)                       AS payment_type,
    CAST(fare_amount AS DECIMAL(10, 2))             AS fare_amount,
    CAST(extra AS DECIMAL(10, 2))                   AS extra,
    CAST(mta_tax AS DECIMAL(10, 2))                 AS mta_tax,
    CAST(tip_amount AS DECIMAL(10, 2))              AS tip_amount,
    CAST(tolls_amount AS DECIMAL(10, 2))            AS tolls_amount,
    CAST(improvement_surcharge AS DECIMAL(10, 2))   AS improvement_surcharge,
    CAST(total_amount AS DECIMAL(10, 2))            AS total_amount,
    CAST(congestion_surcharge AS DECIMAL(10, 2))    AS congestion_surcharge,
    CAST(airport_fee AS DECIMAL(10, 2))             AS airport_fee,
    ingestion_ts,
    CAST(tpep_pickup_datetime AS DATE)              AS pickup_date
FROM (
    SELECT
        *,
        -- TODO (2/5): Natural key for deduplication — partition fields that identify uniqueness
        ROW_NUMBER() OVER (
            PARTITION BY vendor_id, tpep_pickup_datetime, tpep_dropoff_datetime, pu_location_id
            ORDER BY ingestion_ts DESC
        ) AS rn
    FROM iceberg_catalog.bronze.raw_trips
    WHERE
        -- TODO (3/5): Data quality filters
        tpep_pickup_datetime IS NOT NULL
        AND tpep_dropoff_datetime IS NOT NULL
        AND total_amount > 0
        AND trip_distance >= 0
        AND passenger_count >= 0
        -- Date range filter: adjust to match your data's actual date range
        AND CAST(tpep_pickup_datetime AS DATE) >= DATE '2024-01-01'
        AND CAST(tpep_pickup_datetime AS DATE) <  DATE '2024-02-01'
) t
WHERE rn = 1;
