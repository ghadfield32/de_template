-- =============================================================================
-- 05_bronze.sql.tmpl — Bronze Layer: Kafka → Iceberg (raw landing)
-- =============================================================================
-- Bronze = exact copy of source data. Parse timestamps, add ingestion_ts.
-- No filtering, no business logic, no deduplication.
--
-- CUSTOMIZE THIS FILE for a new dataset:
--   1. Rename bronze.raw_trips → bronze.raw_{your_domain}
--   2. Match column list with 01_source.sql.tmpl
--   3. Update TO_TIMESTAMP() calls to match your timestamp format
--   4. Keep ingestion_ts AS CURRENT_TIMESTAMP as the last column
-- =============================================================================

-- Create bronze table (unpartitioned — raw append-only landing zone)
CREATE TABLE IF NOT EXISTS iceberg_catalog.bronze.raw_trips (
    vendor_id               STRING,
    tpep_pickup_datetime    TIMESTAMP(3),
    tpep_dropoff_datetime   TIMESTAMP(3),
    passenger_count         BIGINT,
    trip_distance           DOUBLE,
    rate_code_id            BIGINT,
    store_and_fwd_flag      STRING,
    pu_location_id          BIGINT,
    do_location_id          BIGINT,
    payment_type            BIGINT,
    fare_amount             DOUBLE,
    extra                   DOUBLE,
    mta_tax                 DOUBLE,
    tip_amount              DOUBLE,
    tolls_amount            DOUBLE,
    improvement_surcharge   DOUBLE,
    total_amount            DOUBLE,
    congestion_surcharge    DOUBLE,
    airport_fee             DOUBLE,
    ingestion_ts            TIMESTAMP(3)
) WITH (
    'format-version'                    = '2',
    'write.format.default'              = 'parquet',
    'write.parquet.compression-codec'   = 'snappy'
);

-- Insert: parse raw string timestamps, add ingestion timestamp
INSERT INTO iceberg_catalog.bronze.raw_trips
SELECT
    vendor_id,
    TO_TIMESTAMP(tpep_pickup_datetime,  'yyyy-MM-dd HH:mm:ss') AS tpep_pickup_datetime,
    TO_TIMESTAMP(tpep_dropoff_datetime, 'yyyy-MM-dd HH:mm:ss') AS tpep_dropoff_datetime,
    passenger_count,
    trip_distance,
    rate_code_id,
    store_and_fwd_flag,
    pu_location_id,
    do_location_id,
    payment_type,
    fare_amount,
    extra,
    mta_tax,
    tip_amount,
    tolls_amount,
    improvement_surcharge,
    total_amount,
    congestion_surcharge,
    airport_fee,
    CURRENT_TIMESTAMP AS ingestion_ts
FROM kafka_raw_trips;
