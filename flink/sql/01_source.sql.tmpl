-- =============================================================================
-- 01_source.sql.tmpl — Kafka Source Table (BATCH mode)
-- =============================================================================
-- Rendered by scripts/render_sql.py from environment variables.
-- Sets batch execution mode + defines the Kafka source table.
--
-- CUSTOMIZE THIS FILE for a new dataset:
--   1. Rename kafka_raw_trips → kafka_raw_{your_domain}
--   2. Replace the column list with your JSON schema fields
--   3. Update the timestamp field name and format pattern
--   4. Update the event_time computed column expression
--   5. Update 'topic' = '${TOPIC}' stays as-is (substituted from .env)
--
-- Type guide:
--   text / IDs / codes  → STRING
--   numeric IDs, counts → BIGINT
--   decimal values      → DOUBLE (source) → DECIMAL in silver
--   boolean             → BOOLEAN
--   raw timestamp str   → STRING (parse with TO_TIMESTAMP in bronze INSERT)
-- =============================================================================

-- Batch session settings (table.dml-sync blocks until INSERT finishes)
SET 'execution.runtime-mode' = 'batch';
SET 'table.dml-sync' = 'true';

-- Kafka source: bounded scan (reads all existing messages and stops)
CREATE TABLE IF NOT EXISTS kafka_raw_trips (
    -- NYC Yellow Taxi fields (replace with your dataset's JSON fields)
    vendor_id               STRING,
    tpep_pickup_datetime    STRING,         -- raw timestamp; parsed in bronze
    tpep_dropoff_datetime   STRING,         -- raw timestamp; parsed in bronze
    passenger_count         BIGINT,
    trip_distance           DOUBLE,
    rate_code_id            BIGINT,
    store_and_fwd_flag      STRING,
    pu_location_id          BIGINT,
    do_location_id          BIGINT,
    payment_type            BIGINT,
    fare_amount             DOUBLE,
    extra                   DOUBLE,
    mta_tax                 DOUBLE,
    tip_amount              DOUBLE,
    tolls_amount            DOUBLE,
    improvement_surcharge   DOUBLE,
    total_amount            DOUBLE,
    congestion_surcharge    DOUBLE,
    airport_fee             DOUBLE,

    -- Computed: event time for watermarking
    event_time AS TO_TIMESTAMP(tpep_pickup_datetime, 'yyyy-MM-dd HH:mm:ss'),
    WATERMARK FOR event_time AS event_time - INTERVAL '10' SECOND
) WITH (
    'connector'                     = 'kafka',
    'topic'                         = '${TOPIC}',
    'properties.bootstrap.servers'  = 'broker:9092',
    'properties.group.id'           = 'flink-consumer',
    'scan.startup.mode'             = 'earliest-offset',
    'scan.bounded.mode'             = 'latest-offset',   -- batch: stop at current end
    'format'                        = 'json',
    'json.ignore-parse-errors'      = 'true'
);
