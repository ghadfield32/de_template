-- =============================================================================
-- 01_source_streaming.sql.tmpl — Kafka Source Table (STREAMING mode)
-- =============================================================================
-- Rendered by scripts/render_sql.py when MODE=streaming_bronze.
-- Sets streaming execution mode (no table.dml-sync — jobs run indefinitely).
-- No scan.bounded.mode — reads continuously from Kafka.
--
-- CUSTOMIZE THIS FILE for a new dataset:
--   Same column list customization as 01_source.sql.tmpl.
--   Keep this file in sync with 01_source.sql.tmpl for columns.
-- =============================================================================

-- Streaming session settings (jobs run indefinitely)
SET 'execution.runtime-mode' = 'streaming';

-- Kafka source: unbounded stream (no scan.bounded.mode)
CREATE TABLE IF NOT EXISTS kafka_raw_trips (
    -- NYC Yellow Taxi fields (replace with your dataset's JSON fields)
    vendor_id               STRING,
    tpep_pickup_datetime    STRING,
    tpep_dropoff_datetime   STRING,
    passenger_count         BIGINT,
    trip_distance           DOUBLE,
    rate_code_id            BIGINT,
    store_and_fwd_flag      STRING,
    pu_location_id          BIGINT,
    do_location_id          BIGINT,
    payment_type            BIGINT,
    fare_amount             DOUBLE,
    extra                   DOUBLE,
    mta_tax                 DOUBLE,
    tip_amount              DOUBLE,
    tolls_amount            DOUBLE,
    improvement_surcharge   DOUBLE,
    total_amount            DOUBLE,
    congestion_surcharge    DOUBLE,
    airport_fee             DOUBLE,

    -- Computed: event time for watermarking
    event_time AS TO_TIMESTAMP(tpep_pickup_datetime, 'yyyy-MM-dd HH:mm:ss'),
    WATERMARK FOR event_time AS event_time - INTERVAL '10' SECOND
) WITH (
    'connector'                     = 'kafka',
    'topic'                         = '${TOPIC}',
    'properties.bootstrap.servers'  = 'broker:9092',
    'properties.group.id'           = 'flink-consumer',
    'scan.startup.mode'             = 'earliest-offset',
    'format'                        = 'json',
    'json.ignore-parse-errors'      = 'true'
);
